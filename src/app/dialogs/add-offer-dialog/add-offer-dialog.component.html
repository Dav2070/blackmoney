<dav-dialog
	#dialog
	[headline]="locale.headline"
	[primaryButtonText]="actionsLocale.save"
	[defaultButtonText]="actionsLocale.cancel"
	[visible]="visible"
	maxWidth="700"
	[loading]="loading"
	(dismiss)="hide()"
	(primaryButtonClick)="submit()"
	(defaultButtonClick)="hide()"
>
	<form>
		<!-- Tab Navigation -->
		<dav-tab-bar>
			<dav-tab-bar-item
				id="tab-grunddaten"
				[active]="currentTab === 0"
				(click)="currentTab = 0"
			>
				{{ locale.tab1 }}
			</dav-tab-bar-item>
			<dav-tab-bar-item
				id="tab-menu-items"
				[active]="currentTab === 1"
				(click)="currentTab = 1"
			>
				{{ locale.tab2 }}
			</dav-tab-bar-item>
			<dav-tab-bar-item
				id="tab-verfuegbarkeit"
				[active]="currentTab === 2"
				(click)="currentTab = 2"
			>
				{{ locale.tab3 }}
			</dav-tab-bar-item>
		</dav-tab-bar>

		<!-- Tab 1: Grunddaten -->
		@if (currentTab === 0) {
			<div class="tab-content">
				<h4>{{ locale.basicData }}</h4>

				<div class="dialog-formfield-container">
					<dav-textfield
						[value]="id.toString()"
						[label]="locale.id"
						[disabled]="loading"
						[errorMessage]="idError"
						type="number"
						(change)="idChange($any($event).detail.value)"
					></dav-textfield>
				</div>

				<div class="dialog-formfield-container">
					<dav-textfield
						[value]="name"
						[label]="locale.name"
						[disabled]="loading"
						[errorMessage]="nameError"
						(change)="nameChange($any($event).detail.value)"
					></dav-textfield>
				</div>

				<div class="dialog-formfield-container">
					<label class="form-label">{{ locale.offerType }}</label>
					<div class="radio-group">
						<label class="radio-label">
							<input
								type="radio"
								name="offerType"
								value="FIXED_PRICE"
								[checked]="offerType === 'FIXED_PRICE'"
								(change)="offerTypeChange('FIXED_PRICE')"
							/>
							<span>{{ locale.fixedPrice }}</span>
						</label>
						<label class="radio-label">
							<input
								type="radio"
								name="offerType"
								value="DISCOUNT"
								[checked]="offerType === 'DISCOUNT'"
								(change)="offerTypeChange('DISCOUNT')"
							/>
							<span>{{ locale.discount }}</span>
						</label>
					</div>
				</div>

				@if (offerType === "DISCOUNT") {
					<div class="dialog-formfield-container">
						<label class="form-label">{{ locale.discountType }}</label>
						<div class="radio-group">
							<label class="radio-label">
								<input
									type="radio"
									name="discountType"
									value="PERCENTAGE"
									[checked]="discountType === 'PERCENTAGE'"
									(change)="discountTypeChange('PERCENTAGE')"
								/>
								<span>{{ locale.percentage }}</span>
							</label>
							<label class="radio-label">
								<input
									type="radio"
									name="discountType"
									value="AMOUNT"
									[checked]="discountType === 'AMOUNT'"
									(change)="discountTypeChange('AMOUNT')"
								/>
								<span>{{ locale.amount }}</span>
							</label>
						</div>
					</div>
				}

				<div class="dialog-formfield-container">
					<dav-textfield
						[value]="offerValue.toString()"
						[label]="
							offerType === 'FIXED_PRICE'
								? locale.price
								: discountType === 'PERCENTAGE'
									? locale.discountPercentage
									: locale.discountAmount
						"
						[disabled]="loading"
						[errorMessage]="offerValueError"
						type="number"
						step="0.01"
						(change)="offerValueChange($any($event).detail.value)"
					></dav-textfield>
				</div>

				<div class="dialog-formfield-container">
					<dav-checkbox
					[checked]="takeaway"
					[label]="locale.takeaway"
					[disabled]="loading"
					(change)="takeawayCheckboxChange($any($event).detail.checked)"
					></dav-checkbox>
				</div>
			</div>
		}

		<!-- Tab 2: OfferItems -->
		@if (currentTab === 1) {
			<div class="tab-content">
			@if (isSpecialMode) {
				<!-- Special Mode: Nur Produktauswahl f체r das eine Item -->
				<h4>{{ locale.selectProducts }}</h4>
				
				@if (offerItems.length > 0) {
					<div class="dialog-formfield-container">
						<div class="categories-list">
							@for (category of getProductsByCategory(); track category.categoryUuid) {
								<div class="category-section">
									<button
										type="button"
										class="category-header"
										(click)="toggleCategory(category.categoryUuid)"
									>
										<fa-icon
											[icon]="isCategoryExpanded(category.categoryUuid) ? faChevronDown : faChevronRight"
											class="chevron-icon"
										></fa-icon>
										<span class="category-name">{{ category.categoryName }}</span>
										<span class="category-count">({{ category.products.length }})</span>
									</button>

									@if (isCategoryExpanded(category.categoryUuid)) {
										<div class="products-grid">
											@for (product of category.products; track product.uuid) {
												<label class="product-checkbox">
													<input
														type="checkbox"
														[checked]="isProductSelectedForItem(offerItems[0], product)"
														(change)="toggleProductSelectionForItem(offerItems[0], product)"
														[disabled]="loading"
													/>
													<span>{{ product.name }}</span>
												</label>
											}
										</div>
									}
								</div>
							}
						</div>
					</div>

					<!-- Ausgew채hlte Produkte anzeigen -->
					@if (offerItems[0].products.length > 0) {
						<div class="selected-products">
							<h5>{{ locale.selectedProducts }}</h5>
							<div class="item-products">
								@for (product of offerItems[0].products; track product.uuid) {
									<span class="product-chip">{{ product.name }}</span>
								}
							</div>
						</div>
					}
				}
			} @else {
				<!-- Men체 Mode: Normale Item-Verwaltung -->
				<h4>{{ locale.offerItems }}</h4>

				<!-- Existing Items -->
				@if (offerItems.length > 0) {
					<div class="items-list">
						@for (item of offerItems; track item.uuid) {
							<div class="item-card">
								<div class="item-header">
									<div class="item-info">
										<strong>{{ item.name }}</strong>
										<span class="item-meta"
											>Max. {{ item.maxSelections }} ausw채hlbar</span
										>
									</div>
									<dav-icon-button size="xs" (click)="removeOfferItem(item)">
										<fa-icon [icon]="faTrash"></fa-icon>
									</dav-icon-button>
								</div>
								<div class="item-products">
									@for (product of item.products; track product.uuid) {
										<span class="product-chip">{{ product.name }}</span>
									}
								</div>
							</div>
						}
					</div>
				}

				<!-- Add New Item -->
				<div class="add-item-section">
					<h5>{{ locale.addNewItem }}</h5>

					<div class="dialog-formfield-container">
						<dav-textfield
							[value]="newItemName"
							[label]="locale.itemName"
							[disabled]="loading"
							[errorMessage]="newItemNameError"
							(change)="newItemNameChange($any($event).detail.value)"
						></dav-textfield>
					</div>

					<div class="dialog-formfield-container">
						<dav-textfield
							[value]="newItemMaxSelections.toString()"
							[label]="locale.maxSelections"
							[disabled]="loading"
							type="number"
							min="1"
							(change)="newItemMaxSelectionsChange($any($event).detail.value)"
						></dav-textfield>
					</div>

					<div class="dialog-formfield-container">
						<label class="form-label">{{ locale.selectProducts }}</label>
						<div class="categories-list">
							@for (category of getProductsByCategory(); track category.categoryUuid) {
								<div class="category-section">
									<button
										type="button"
										class="category-header"
										(click)="toggleCategory(category.categoryUuid)"
									>
										<fa-icon
											[icon]="isCategoryExpanded(category.categoryUuid) ? faChevronDown : faChevronRight"
											class="chevron-icon"
										></fa-icon>
										<span class="category-name">{{ category.categoryName }}</span>
										<span class="category-count">({{ category.products.length }})</span>
									</button>
									@if (isCategoryExpanded(category.categoryUuid)) {
										<div class="products-grid">
											@for (product of category.products; track product.uuid) {
												<label class="product-checkbox">
													<input
														type="checkbox"
														[checked]="isProductSelected(product)"
														(change)="toggleProductSelection(product)"
													/>
													<span>{{ product.name }}</span>
												</label>
											}
										</div>
									}
								</div>
							}
						</div>
					</div>

					<dav-button type="button" [disabled]="loading" (click)="addOfferItem()">
						{{ locale.addItem }}
					</dav-button>
				</div>
			}
			</div>
		}

		<!-- Tab 3: Zeiten -->
		@if (currentTab === 2) {
			<div class="tab-content">
				<h4>{{ locale.availability }}</h4>

				<div class="dialog-formfield-container">
					<label class="form-label">{{ locale.weekdays }}</label>
					<div class="weekdays-grid">
						@for (weekday of weekdayOptions; track weekday.value) {
							<label class="weekday-checkbox">
								<input
									type="checkbox"
									[checked]="isWeekdaySelected(weekday.value)"
									(change)="toggleWeekday(weekday.value)"
								/>
								<span>{{ weekday.label }}</span>
							</label>
						}
						<button
							type="button"
							class="select-all-button"
							(click)="selectAllWeekdays()"
						>
							{{ locale.selectAllDays }}
						</button>
					</div>
				</div>

				<div class="time-fields">
					<div class="dialog-formfield-container">
						<dav-textfield
							[value]="startTime"
							[label]="locale.startTime"
							[disabled]="loading"
							type="time"
							(change)="startTimeChange($any($event).detail.value)"
						></dav-textfield>
					</div>

					<div class="dialog-formfield-container">
						<dav-textfield
							[value]="endTime"
							[label]="locale.endTime"
							[disabled]="loading"
							type="time"
							(change)="endTimeChange($any($event).detail.value)"
						></dav-textfield>
					</div>
				</div>
			</div>
		}

		<!-- Navigation Buttons -->
		<div class="navigation-buttons">
			@if (currentTab > 0) {
				<dav-button type="button" (click)="previousTab()">
					{{ locale.previous }}
				</dav-button>
			}
			@if (currentTab < 2) {
				<dav-button type="button" (click)="nextTab()">
					{{ locale.next }}
				</dav-button>
			}
		</div>
	</form>
</dav-dialog>
