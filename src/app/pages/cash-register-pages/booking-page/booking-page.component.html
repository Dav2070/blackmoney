<div class="container">
	<div class="header">
		<app-header [showButton]="false" />
	</div>

	<div class="orders-numpad-container">
		<div class="orders-container">
			@if (room != null && table != null) {
				<div class="table-info-container">
					<dav-icon-button size="sm" href="/dashboard" (click)="navigateToDashboard($event)">
						<fa-icon [icon]="faArrowLeft"></fa-icon
					></dav-icon-button>

					<p>
						{{
							locale.tableHeadline.replace(
								"{name}",
								table.name.toString()
							)
						}}
						— {{ room.name }}
					</p>

					<dav-icon-button size="sm" (click)="selectTableButtonClick()">
						<fa-icon [icon]="faArrowRightArrowLeft"></fa-icon>
					</dav-icon-button>
				</div>
			}

			<ul class="order-items-container">
				@if (loading) {
					<dav-skeleton class="order-item-card-skeleton"></dav-skeleton>
					<dav-skeleton class="order-item-card-skeleton"></dav-skeleton>
					<dav-skeleton class="order-item-card-skeleton"></dav-skeleton>
					<dav-skeleton class="order-item-card-skeleton"></dav-skeleton>
					<dav-skeleton class="order-item-card-skeleton"></dav-skeleton>
				}

				@if (
					!loading &&
					stagedItems.getOrderItems().length === 0 &&
					stagedItems.getOfferOrderItems().length === 0
				) {
					<p class="no-products-message">Keine Produkte ausgewählt</p>
				}				
				@for (
					orderItem of stagedItems.getOrderItems();
					track orderItem.uuid
				) {
					@if (orderItem.type === "product") {
						<app-order-item-card
							[orderItem]="orderItem"
							[selectedOrderItemUuid]="selectedItem?.uuid"
							(click)="selectItem(orderItem, stagedItems)"
						></app-order-item-card>
					} @else if (orderItem.type === "menu" || orderItem.type === "special") {
						<app-offer-order-item-card
							[orderItem]="orderItem"
							[selectedOrderItemUuid]="selectedItem?.uuid"
							(click)="selectItem(orderItem, stagedItems)"
						></app-offer-order-item-card>
					}
				}
			</ul>

			@if (!loading && bookedItems.getOrderItems().length > 0) {
				<div class="staged-items-separator">
					<p>Gebuchte Produkte</p>
					<div class="separator"></div>
				</div>
			}

			<ul class="order-items-container">
				@for (
					orderItem of bookedItems.getOrderItems();
					track orderItem.uuid
				) {
					@if (orderItem.type === "product") {
						<app-order-item-card
							[orderItem]="orderItem"
							[selectedOrderItemUuid]="selectedItem?.uuid"
							(click)="selectItem(orderItem, bookedItems)"
						></app-order-item-card>
					} @else if (orderItem.type === "menu" || orderItem.type === "special") {
						<app-offer-order-item-card
							[orderItem]="orderItem"
							[selectedOrderItemUuid]="selectedMenuItem?.uuid"
							(click)="selectItem(orderItem, bookedItems)"
						></app-offer-order-item-card>
					}
				}
			</ul>
		</div>

		<div class="numpad-container">
			<div class="console-output">
				<p>{{ console }}</p>
			</div>

			<div class="numpad-buttons">
				<dav-button color="secondary" tonal (click)="consoleInput('1')">
					1
				</dav-button>

				<dav-button color="secondary" tonal (click)="consoleInput('2')">
					2
				</dav-button>

				<dav-button color="secondary" tonal (click)="consoleInput('3')">
					3
				</dav-button>

				<dav-button
					color="secondary"
					text
					[disabled]="
						commaUsed || !consoleActive || checkforZero() || xUsed
					"
					(click)="setAnzahl()"
				>
					×
				</dav-button>

				<dav-button color="secondary" tonal (click)="consoleInput('4')">
					4
				</dav-button>

				<dav-button color="secondary" tonal (click)="consoleInput('5')">
					5
				</dav-button>

				<dav-button color="secondary" tonal (click)="consoleInput('6')">
					6
				</dav-button>

				<dav-button color="secondary" text (click)="showTotal()">
					Clear
				</dav-button>

				<dav-button color="secondary" tonal (click)="consoleInput('7')">
					7
				</dav-button>

				<dav-button color="secondary" tonal (click)="consoleInput('8')">
					8
				</dav-button>

				<dav-button color="secondary" tonal (click)="consoleInput('9')">
					9
				</dav-button>

				<dav-button
					color="secondary"
					text
					[disabled]="!consoleActive || commaUsed || checkArticleNumber()"
					(click)="bookById()"
				>
					Artikel
				</dav-button>

				<dav-button
					color="secondary"
					text
					[disabled]="commaUsed || !consoleActive || xUsed"
					(click)="consoleInput(','); commaUsed = true"
				>
					,
				</dav-button>

				<dav-button color="secondary" tonal (click)="consoleInput('0')">
					0
				</dav-button>

				<dav-button
					color="secondary"
					text
					[disabled]="!selectedItem"
					(click)="subtractitem(selectedItem)"
				>
					-
				</dav-button>

				<dav-button
					color="secondary"
					text
					[disabled]="!selectedItem"
					(click)="
						addSelectedItem(selectedItem);
					"
				>
					+
				</dav-button>
			</div>
		</div>
	</div>

	<div class="product-selection-container">
		<div class="product-items">
			@if (loading) {
				<dav-skeleton
					class="product-item-skeleton"
					style="width: 145px"
				></dav-skeleton>
				<dav-skeleton
					class="product-item-skeleton"
					style="width: 115px"
				></dav-skeleton>
				<dav-skeleton
					class="product-item-skeleton"
					style="width: 130px"
				></dav-skeleton>
				<dav-skeleton
					class="product-item-skeleton"
					style="width: 120px"
				></dav-skeleton>
				<dav-skeleton
					class="product-item-skeleton"
					style="width: 125px"
				></dav-skeleton>
				<dav-skeleton
					class="product-item-skeleton"
					style="width: 100px"
				></dav-skeleton>
				<dav-skeleton
					class="product-item-skeleton"
					style="width: 140px"
				></dav-skeleton>
				<dav-skeleton
					class="product-item-skeleton"
					style="width: 135px"
				></dav-skeleton>
				<dav-skeleton
					class="product-item-skeleton"
					style="width: 120px"
				></dav-skeleton>
				<dav-skeleton
					class="product-item-skeleton"
					style="width: 110px"
				></dav-skeleton>
				<dav-skeleton
					class="product-item-skeleton"
					style="width: 130px"
				></dav-skeleton>
				<dav-skeleton
					class="product-item-skeleton"
					style="width: 100px"
				></dav-skeleton>
			} @else if (selectedCategory === "menues") {
				@for (menu of menues; track menu.uuid) {
					<dav-button (click)="clickMenu(menu)">
						{{ menu.name }}
					</dav-button>
				}
			} @else if (selectedCategory === "specials") {
				@for (special of specials; track special.uuid) {
					<dav-button (click)="clickSpecial(special)">
						{{ special.name }}
					</dav-button>
				}
			} @else {
				@for (item of selectedInventory; track item.uuid) {
					<dav-button (click)="clickItem(item)">
						{{ item.name }}
					</dav-button>
				}
			}
		</div>
	</div>

	<div class="categories-sidenav-container">
		<dav-sidenav>
			@if (loading) {
				<dav-skeleton class="category-item-skeleton"></dav-skeleton>
				<dav-skeleton class="category-item-skeleton"></dav-skeleton>
				<dav-skeleton class="category-item-skeleton"></dav-skeleton>
				<dav-skeleton class="category-item-skeleton"></dav-skeleton>
				<dav-skeleton class="category-item-skeleton"></dav-skeleton>
				<dav-skeleton class="category-item-skeleton"></dav-skeleton>
				<dav-skeleton class="category-item-skeleton"></dav-skeleton>
				<dav-skeleton class="category-item-skeleton"></dav-skeleton>
				<dav-skeleton class="category-item-skeleton"></dav-skeleton>
				<dav-skeleton class="category-item-skeleton"></dav-skeleton>
			} @else {
				<!-- Menues & Specials -->
				<dav-sidenav-item
					value="Menüs"
					[active]="selectedCategory === 'menues'"
					(click)="showMenus()"
				></dav-sidenav-item>

				<dav-sidenav-item
					value="Specials"
					[active]="selectedCategory === 'specials'"
					(click)="showSpecials()"
				></dav-sidenav-item>

				<!-- Dynamic categories -->
				@for (category of categories; track category.uuid) {
					<dav-sidenav-item
						[value]="category.name"
						[active]="selectedCategory === category.uuid"
						(click)="selectCategory(category)"
					></dav-sidenav-item>
				}
			}
		</dav-sidenav>
	</div>

	<div class="footer">
		<div id="footerButtonsContainer">
			<button mat-flat-button class="footerButton" (click)="sendOrder()">
				Bestellung abschicken
			</button>
			<button
				mat-flat-button
				class="footerButton"
				[disabled]="
					commaUsed ||
					!consoleActive ||
					table?.uuid == console ||
					checkforZero() ||
					xUsed
				"
				(click)="navigateToTransferPage()"
			>
				Umbuchen
			</button>
			<button mat-flat-button class="footerButton" [routerLink]="['../../']">
				Tischplan
			</button>
			<button
				mat-flat-button
				class="footerButton"
				[routerLink]="['../' + console]"
				[disabled]="
					commaUsed ||
					!consoleActive ||
					table?.uuid == console ||
					checkforZero() ||
					xUsed
				"
			>
				Tisch
			</button>
			<button mat-flat-button class="footerButton" (click)="openBills()">
				Rechnungen
			</button>
			<button
				mat-flat-button
				class="footerButton"
				(click)="createBill('CASH')"
				[disabled]="bookedItems.isEmpty()"
			>
				Bar
			</button>
			<button
				mat-flat-button
				class="footerButton"
				(click)="createBill('CARD')"
				[disabled]="bookedItems.isEmpty()"
			>
				Karte
			</button>
			<button
				mat-flat-button
				class="footerButton"
				[routerLink]="['separate']"
				[disabled]="bookedItems.isEmpty()"
			>
				Getrennt
			</button>
		</div>
	</div>
</div>

<div class="bill-popup-overlay" [ngClass]="{ visible: isBillPopupVisible }">
	@if (pickedBill) {
		<div class="bill-popup-content">
			<div class="bill-list">
				@for (bill of bills; track bill.uuid) {
					<div
						class="bill-item"
						(click)="pickedBill = bill"
						[class.bill-selected]="pickedBill === bill"
					>
						<span>Tisch {{ bill.table.name }}</span>
						<span class="bill-payment-method">{{
							bill.paymentMethod
						}}</span>
						<span>
							{{ pickedBill.paidAt.toLocaleDateString("de-DE") }}
						</span>
						<span
							>{{
								bill.paidAt.toLocaleTimeString([], {
									hour: "2-digit",
									minute: "2-digit"
								})
							}}
							Uhr</span
						>
						<span>{{ calculateBillTotal(bill) }} €</span>
					</div>
				}
			</div>

			<div class="bill-details">
				<h2>
					Tisch {{ pickedBill.table.name }}
					<span class="bill-time">
						{{ pickedBill.paidAt.toLocaleTimeString("de-DE") }} -
						{{ pickedBill.paidAt.toLocaleDateString("de-DE") }}
					</span>
				</h2>
				<div class="bill-items">
					@for (item of pickedBill.orderItems; track item.uuid) {
						<div class="bill-item-detail">
							<div class="item-header">
								<span>{{ item.count }} x {{ item.product.name }}</span>
								<span class="total-price"
									>{{ calculateTotalPriceOfOrderItem(item) }}€</span
								>
							</div>

							@if (item.orderItemVariations.length > 0) {
								@for (
									variation of item.orderItemVariations;
									track variation.uuid
								) {
									<span
										>{{ variation.count }} x
										@for (
											variationItem of variation.variationItems;
											track variationItem.uuid
										) {
											{{ variationItem.name }}
											<span class="variationItem-price">
												@if (variationItem.additionalCost > 0) {
													+
													{{
														(
															(variation.count *
																variationItem.additionalCost) /
															100
														).toFixed(2)
													}}€
												}
											</span>
											<br />
										}
									</span>
								}
							}
						</div>
					}
				</div>
				<div class="bill-total">
					<span>Gesamt</span>
					<span>{{ calculateBillTotal(pickedBill) }}€</span>
				</div>
				<div class="bill-buttons">
					<button class="bill-back-button">Tisch zurückholen</button>
					<button class="bill-close-button" (click)="closeBills()">
						Schließen
					</button>
				</div>
			</div>
		</div>
	}
</div>

<div class="popup-overlay" [ngClass]="{ visible: isItemPopupVisible }">
	@if (minusUsed == false) {
		<div class="popup-content">
			@if (lastClickedItem != null) {
				<h2>
					{{ lastClickedItem.variations[tmpCountVariations].name }}
				</h2>
				@for (
					variationMap of tmpPickedVariationResource;
					track variationMap
				) {
					@if (variationMap.get(tmpCountVariations)) {
						@for (
							variation of variationMap.get(tmpCountVariations).values();
							track variation.uuid
						) {
							@if (tmpCountVariations != 0) {
								{{ displayVariation(variation) }}
							}

							<div class="popup-content-dish">
								<button
									mat-mini-fab
									[disabled]="variation.count == 0"
									(click)="removeVariation(variation)"
								>
									<mat-icon>remove</mat-icon>
								</button>
								<b>
									{{ variation.count }}x
									{{ variation.display }}
								</b>
								<button
									mat-mini-fab
									[disabled]="checkForPlusaddVariation(variation)"
									(click)="addVariation(variation)"
								>
									<mat-icon>add</mat-icon>
								</button>
							</div>
						}
					}
				}
			}
			<button mat-flat-button (click)="closeItemPopup()">Schließen</button>
			<button
				mat-flat-button
				[disabled]="checkForSendVariation()"
				(click)="sendVariation()"
			>
				Auswählen
			</button>
		</div>
	} @else {
		<div class="popup-content">
			@if (selectedItem != null) {
				<h2>
					{{ selectedItem.product.name }}
				</h2>
				@for (
					variation of tmpSelectedItem.orderItemVariations;
					track variation.uuid
				) {
					<div class="popup-content-dish">
						<button
							mat-mini-fab
							[disabled]="variation.count == 0"
							(click)="removeVariationSubtraction(variation)"
						>
							<mat-icon>remove</mat-icon>
						</button>
						<b>
							{{ variation.count }}x
							@for (
								variationItem of variation.variationItems;
								track variationItem.uuid
							) {
								{{ variationItem.name }}
							}
						</b>
						<button
							mat-mini-fab
							[disabled]="checkForPlus(variation)"
							(click)="addVariationSubtraction(variation)"
						>
							<mat-icon>add</mat-icon>
						</button>
					</div>
				}
			}
			<button mat-flat-button (click)="closeItemPopup()">Schließen</button>
			<button mat-flat-button (click)="sendDeleteVariation(tmpSelectedItem)">
				Auswählen
			</button>
		</div>
	}
</div>

<div class="popup-overlay" [ngClass]="{ visible: isMenuePopupVisible }">
	@if (this.currentMenu) {
		<div class="Special-popup-content">
			<div class="menue-left">
				<div class="categories-section">
					<h3>Kategorien</h3>
					<div class="category-list">
						@for (item of currentMenu.offerItems; track item.uuid) {
							<button
								[disabled]="item.maxSelections <= 0"
								[class.selected-category]="currentIndex === $index"
								(click)="
									changeSelectedMenuInventory(
										item,
										item.maxSelections,
										$index
									)
								"
								mat-flat-button
							>
								{{ item.name }} ({{ item.maxSelections }})
							</button>
						}
					</div>
				</div>
			</div>
			<div class="specials-center">
				<div class="products-section">
					<h3>
						Produkte - Wähle
						{{ this.currentMenu.offerItems[currentIndex].maxSelections }}
						Produkte aus
					</h3>
					<div class="product-list">
						@for (product of specialProducts; track product.uuid) {
							<button
								[disabled]="
									this.currentMenu.offerItems[currentIndex]
										.maxSelections <= 0
								"
								(click)="clickSpecialProduct(product)"
								mat-flat-button
							>
								{{ product.name }}
							</button>
						}
					</div>
				</div>
			</div>
			<div class="specials-right">
				<div class="selection-section">
					<h3>Ebenen</h3>
					<div class="selected-products">
						@for (
							item of tmpSpecialAllItemsHandler.getOrderItems();
							track item.uuid
						) {
							<div class="selected-product">
								@if (item.orderItemVariations.length > 0) {
									<span>
										{{ item.count }}x {{ item.product.name }}
									@for (
										variation of item.orderItemVariations;
										track variation.uuid
									) {
										{{ variation.count }}x
										@for (
											variationItem of variation.variationItems;
											track variationItem.uuid
										) {
											{{ variationItem.name }}
										}
										<button
												mat-mini-fab
												(click)="editSpecial(item)"
												color="accent"
											>
												<mat-icon>edit</mat-icon>
										</button>
										<button
											mat-mini-fab
											(click)="removeMenuItem(item)"
											color="warn"
										>
											<mat-icon>X</mat-icon>
										</button>
									}
									</span>
								} @else {
									<button
										mat-mini-fab
										(click)="removeMenuItem(item)"
										color="warn"
									>
										<mat-icon>-</mat-icon>
									</button>
									<span>
										{{ item.count }}x {{ item.product.name }}
									</span>
								}
							</div>
						}
					</div>
				</div>
				<div class="button-section">
					<button
						class="special-button confirm-btn"
						(click)="confirmMenu()"
					>
						✓
					</button>
					<button
						class="special-button close-btn"
						(click)="closeSpecials()"
					>
						✕
					</button>
				</div>
			</div>
		</div>
	} @else {
		<div class="Special-popup-content">
			<div class="specials-left">
				<div class="categories-section">
					<h3>Kategorien</h3>
					<div class="category-list">
						@for (category of specialCategories; track category.uuid) {
							<button
								(click)="changeSelectedSpecialInventory(category)"
								mat-flat-button
							>
								{{ category.name }}
							</button>
						}
					</div>
				</div>
			</div>
			<div class="specials-center">
				<div class="products-section">
					<h3>Produkte</h3>
					<div class="product-list">
						@for (product of specialProducts; track product.uuid) {
							<button
								(click)="clickSpecialProduct(product)"
								mat-flat-button
							>
								{{ product.name }}
							</button>
						}
					</div>
				</div>
			</div>
			<div class="specials-right">
				<div class="selection-section">
					<h3>Auswahl</h3>
					<div class="selected-products">
						@for (
							item of tmpSpecialAllItemsHandler.getOrderItems();
							track item.uuid
						) {
							<div class="selected-product">
								@if (item.orderItemVariations.length > 0) {
									<button
										mat-mini-fab
										(click)="editSpecial(item)"
										color="accent"
									>
										<mat-icon>edit</mat-icon>
									</button>
									<button
										mat-mini-fab
										(click)="removeMenuItem(item)"
										color="warn"
									>
										<mat-icon>X</mat-icon>
									</button>
									<span>
										{{ item.count }}x {{ item.product.name }}

										@for (
											variation of item.orderItemVariations;
											track variation.uuid
										) {
											{{ variation.count }}x
											@for (
												variationItem of variation.variationItems;
												track variationItem.uuid
											) {
												{{ variationItem.name }}
											}
										}
									</span>
								} @else {
									<button
										mat-mini-fab
										(click)="removeSpecial(item)"
										color="warn"
									>
										<mat-icon>-</mat-icon>
									</button>
									<span>
										{{ item.count }}x {{ item.product.name }}
									</span>
									<button
										mat-mini-fab
										(click)="addSpecial(item)"
										color="primary"
									>
										<mat-icon>+</mat-icon>
									</button>
								}
							</div>
						}
					</div>
				</div>
				<div class="button-section">
					<button
						class="special-button confirm-btn"
						(click)="confirmSpecials()"
					>
						✓
					</button>
					<button
						class="special-button close-btn"
						(click)="closeSpecials()"
					>
						✕
					</button>
				</div>
			</div>
		</div>
	}
</div>

<!-- SpecialVariationPopup -->
<div
	class="popup-overlay"
	[ngClass]="{ visible: isSpecialVariationPopupVisible }"
	style="z-index: 1001"
>
	@if (minusUsed == false) {
		<div class="popup-content">
			@if (lastClickedItem != null) {
				<h2>
					{{ lastClickedItem.variations[tmpCountVariations].name }}
				</h2>
				@for (
					variationMap of tmpPickedVariationResource;
					track variationMap
				) {
					@if (variationMap.get(tmpCountVariations)) {
						@for (
							variation of variationMap.get(tmpCountVariations).values();
							track variation.uuid
						) {
							@if (tmpCountVariations != 0) {
								{{ displayVariation(variation) }}
							}

							<div class="popup-content-dish">
								<button
									mat-mini-fab
									[disabled]="variation.count == 0"
									(click)="removeVariation(variation)"
								>
									<mat-icon>remove</mat-icon>
								</button>
									{{ variation.count }}x
									{{ variation.display }}
								<button
									mat-mini-fab
									[disabled]="checkForPlusaddVariation(variation)"
									(click)="addVariation(variation)"
								>
									<mat-icon>add</mat-icon>
								</button>
							</div>
						}
					}
				}
			}
			<button 
				mat-flat-button 
				[disabled]="checkForSendVariation()"
				(click)="closeSpecialVariationPopup()">
				Schließen
			</button>
			<button
				mat-flat-button
				[disabled]="checkForSendVariation()"
				(click)="sendVariation()"
			>
				Auswählen
			</button>
		</div>
	} @else {
		<div class="popup-content">
			@if (
				selectedMenuItem != null && selectedMenuItem.orderItems.length === 1
			) {
				<!-- Minus-Modus für OfferOrderItems -->
				<h2>
					{{ lastClickedItem.variations[tmpCountVariations].name }}
				</h2>
				@for (
					variationMap of tmpPickedVariationResource;
					track variationMap
				) {
					@if (variationMap.get(tmpCountVariations)) {
						@for (
							variation of variationMap.get(tmpCountVariations).values();
							track variation.uuid
						) {
							@if (tmpCountVariations != 0) {
								{{ displayVariation(variation) }}
							}

							<div class="popup-content-dish">
								<button
									mat-mini-fab
									[disabled]="variation.count == 0"
									(click)="removeVariation(variation)"
								>
									<mat-icon>remove</mat-icon>
								</button>
								<b>
									{{ variation.count }}x
									{{ variation.display }}
								</b>
								<button
									mat-mini-fab
									[disabled]="checkForPlusaddVariation(variation)"
									(click)="addVariation(variation)"
								>
									<mat-icon>add</mat-icon>
								</button>
							</div>
						}
					}
				}
			} @else if (selectedItem != null) {
				<!-- Minus-Modus für normale OrderItems -->
				<h2>
					{{ selectedItem.product.name }}
				</h2>
				@for (
					variation of tmpSelectedItem.orderItemVariations;
					track variation.uuid
				) {
					<div class="popup-content-dish">
						<button
							mat-mini-fab
							[disabled]="variation.count == 0"
							(click)="removeVariationSubtraction(variation)"
						>
							<mat-icon>remove</mat-icon>
						</button>
						<b>
							{{ variation.count }}x
							@for (
								variationItem of variation.variationItems;
								track variationItem.uuid
							) {
								{{ variationItem.name }}
							}
						</b>
						<button
							mat-mini-fab
							[disabled]="checkForPlus(variation)"
							(click)="addVariationSubtraction(variation)"
						>
							<mat-icon>add</mat-icon>
						</button>
					</div>
				}
			}
			<button mat-flat-button (click)="closeSpecialVariationPopup()">
				Schließen
			</button>
			<button mat-flat-button (click)="sendDeleteVariation(tmpSelectedItem)">
				Auswählen
			</button>
		</div>
	}
</div>

<app-select-table-dialog
	#selectTableDialog
	[restaurantUuid]="dataService.restaurant?.uuid"
	[currentRoomUuid]="room?.uuid"
	[currentTableUuid]="table?.uuid"
	(primaryButtonClick)="selectTableDialogPrimaryButtonClick($event)"
></app-select-table-dialog>
