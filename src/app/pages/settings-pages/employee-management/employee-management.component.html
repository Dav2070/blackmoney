<app-settings-bar>
	<div class="employee-management-container">
		<h2 class="headline">Mitarbeiterverwaltung</h2>

		<!-- Rollenverwaltung -->
		<mat-card class="role-card">
			<mat-card-title>
				<mat-icon color="primary">supervisor_account</mat-icon>
				<span>Rollen</span>
			</mat-card-title>
			<mat-divider></mat-divider>
			<div class="role-add-row">
				<mat-form-field appearance="outline" class="role-field">
					<mat-label>Neue Rolle</mat-label>
					<input matInput [(ngModel)]="newRoleName" />
				</mat-form-field>
				<mat-form-field appearance="outline" class="role-field">
					<mat-label>Berechtigungen</mat-label>
					<mat-select multiple [(ngModel)]="newRolePermissions">
						@for (perm of ALL_PERMISSIONS; track perm.code) {
						<mat-option [value]="perm.code">
							{{ perm.label }}
						</mat-option>
						}
					</mat-select>
				</mat-form-field>
				<button
					mat-raised-button
					color="primary"
					(click)="addRole()"
					[disabled]="!newRoleName.trim()"
				>
					Hinzufügen
				</button>
			</div>
			<mat-list>
				@for (role of roles; track role.uuid) {
				<mat-list-item>
					@if (editRole?.uuid !== role.uuid) {
					<div class="role-list-row">
						<span class="role-name">{{ role.name }}</span>
						<mat-chip-list>
							@for (perm of role.permissions; track perm) {
							<mat-chip>{{ getPermissionLabel(perm) }}</mat-chip>
							}
						</mat-chip-list>
						<span class="spacer"></span>
						<button
							mat-icon-button
							color="primary"
							(click)="startEditRole(role)"
						>
							<mat-icon>edit</mat-icon>
						</button>
						<button
							mat-icon-button
							color="warn"
							(click)="deleteRole(role)"
						>
							<mat-icon>delete</mat-icon>
						</button>
					</div>
					} @else {
					<ng-template #editRoleTpl>
						<mat-form-field appearance="outline" class="role-field">
							<input matInput [(ngModel)]="editRoleName" />
						</mat-form-field>
						<mat-form-field appearance="outline" class="role-field">
							<mat-label>Berechtigungen</mat-label>
							<mat-select multiple [(ngModel)]="editRolePermissions">
								@for (perm of ALL_PERMISSIONS; track perm.code) {
								<mat-option [value]="perm.code">
									{{ perm.label }}
								</mat-option>
								}
							</mat-select>
						</mat-form-field>
						<button
							mat-icon-button
							color="primary"
							(click)="saveEditRole()"
						>
							<mat-icon>check</mat-icon>
						</button>
						<button mat-icon-button (click)="cancelEditRole()">
							<mat-icon>close</mat-icon>
						</button>
					</ng-template>
					}
				</mat-list-item>
				}
			</mat-list>
		</mat-card>

		<!-- Mitarbeiterverwaltung -->
		<mat-card class="employee-card">
			<mat-card-title>
				<mat-icon color="primary">people</mat-icon>
				<span>Mitarbeiter</span>
			</mat-card-title>
			<mat-divider></mat-divider>
			<div class="employee-add-row">
				<mat-form-field appearance="outline" class="employee-field">
					<mat-label>Name</mat-label>
					<input matInput [(ngModel)]="newEmployeeName" />
				</mat-form-field>
				<mat-form-field appearance="outline" class="employee-field">
					<mat-label>PIN</mat-label>
					<input matInput [(ngModel)]="newEmployeePin" maxlength="6" />
				</mat-form-field>
				<mat-form-field appearance="outline" class="employee-field">
					<mat-label>Rolle</mat-label>
					<mat-select [(ngModel)]="newEmployeeRoleUuid">
						@for (role of roles; track role.uuid) {
						<mat-option [value]="role.uuid">{{ role.name }}</mat-option>
						}
					</mat-select>
				</mat-form-field>
				<button
					mat-raised-button
					color="primary"
					(click)="addEmployee()"
					[disabled]="
						!newEmployeeName.trim() ||
						!newEmployeePin.trim() ||
						!newEmployeeRoleUuid
					"
				>
					Hinzufügen
				</button>
			</div>
			<mat-list>
				@for (emp of employees; track emp.uuid) {
				<mat-list-item>
					@if (editEmployee?.uuid !== emp.uuid) {
					<div class="role-list-row">
						<span>{{ emp.name }}</span>
						<span class="employee-role">{{
							getRole(emp.roleUuid)?.name || "Keine"
						}}</span>
						<span class="spacer"></span>
						<button
							mat-icon-button
							color="primary"
							(click)="startEditEmployee(emp)"
						>
							<mat-icon>edit</mat-icon>
						</button>
						<button
							mat-icon-button
							color="warn"
							(click)="deleteEmployee(emp)"
						>
							<mat-icon>delete</mat-icon>
						</button>
					</div>
					} @else {
					<ng-template #editEmpTpl>
						<mat-form-field appearance="outline" class="employee-field">
							<input matInput [(ngModel)]="editEmployeeName" />
						</mat-form-field>
						<mat-form-field appearance="outline" class="employee-field">
							<mat-label>PIN</mat-label>
							<input
								matInput
								[(ngModel)]="editEmployeePin"
								maxlength="6"
							/>
						</mat-form-field>
						<mat-form-field appearance="outline" class="employee-field">
							<mat-label>Rolle</mat-label>
							<mat-select [(ngModel)]="editEmployeeRoleUuid">
								@for (role of roles; track role.uuid) {
								<mat-option [value]="role.uuid">
									{{ role.name }}
								</mat-option>
								}
							</mat-select>
						</mat-form-field>
						<mat-form-field appearance="outline" class="employee-field">
							<mat-label>Zusätzliche Rechte</mat-label>
							<mat-select
								multiple
								[(ngModel)]="editEmployeeExtraPermissions"
							>
								@for (perm of ALL_PERMISSIONS; track perm.code) {
								<mat-option [value]="perm.code">
									{{ perm.label }}
								</mat-option>
								}
							</mat-select>
						</mat-form-field>
						<button
							mat-icon-button
							color="primary"
							(click)="saveEditEmployee()"
						>
							<mat-icon>check</mat-icon>
						</button>
						<button mat-icon-button (click)="cancelEditEmployee()">
							<mat-icon>close</mat-icon>
						</button>
					</ng-template>
					}
				</mat-list-item>
				}
			</mat-list>
		</mat-card>
	</div>
</app-settings-bar>
