<app-settings-bar>
	<div class="restaurant-overview-container">
		<!-- Restaurant-Auswahl -->
		<mat-form-field
			appearance="outline"
			style="width: 350px; margin-bottom: 1em"
		>
			<mat-label>Restaurant auswählen</mat-label>
			<mat-select [(ngModel)]="selectedRestaurantIndex">
				@for (r of restaurants; let i = $index; track r) {
					<mat-option [value]="i">
						{{ r.name }}
					</mat-option>
				}
			</mat-select>
		</mat-form-field>
		<button mat-stroked-button color="primary" (click)="addRestaurant()">
			<mat-icon>add</mat-icon> Restaurant hinzufügen
		</button>

		<!-- Restaurant-Stammdaten -->
		<mat-card class="main-card">
			<mat-card-title>
				<mat-icon color="primary" style="margin-right: 8px">
					storefront
				</mat-icon>
				<span>{{ restaurant.name }}</span>
			</mat-card-title>
			<mat-divider></mat-divider>

			@if (!editMode) {
				<!-- Anzeige-Modus -->
				<div class="display-section">
					<div class="info-grid">
						<div>
							<mat-icon>location_on</mat-icon>
							<span>
								{{ restaurant.adresse?.strasse || "" }},
								{{ restaurant.adresse?.plz || "" }}
								{{ restaurant.adresse?.ort || "" }},
								{{ restaurant.adresse?.land || "" }}
							</span>
						</div>
						<div>
							<mat-icon>call</mat-icon>
							<span>{{ restaurant.telefonnummer }}</span>
						</div>
						<div>
							<mat-icon>mail</mat-icon>
							<span>{{ restaurant.email }}</span>
						</div>
						<div>
							<mat-icon>badge</mat-icon>
							<span>Inhaber: {{ restaurant.inhaber }}</span>
						</div>
						<div>
							<mat-icon>receipt_long</mat-icon>
							<span>Steuer-ID: {{ restaurant.steuerId }}</span>
						</div>
					</div>
					<div class="opening-section">
						<h3>Öffnungszeiten</h3>
						<mat-list>
							@for (entry of getOpeningHoursPerDay(); track entry.day) {
								<mat-list-item>
									<strong
										style="min-width: 110px; display: inline-block"
									>
										{{ entry.day }}:
									</strong>
									@if (entry.periods.length) {
										<span>
											@for (
												period of entry.periods;
												let i = $index;
												track period
											) {
												<span>
													{{ i !== 0 ? ", " : "" }}
													{{ period.from }} –
													{{ period.to }}
												</span>
											}
										</span>
									} @else {
										<ng-template #geschlossen>
											<span>geschlossen</span>
										</ng-template>
									}
								</mat-list-item>
							}
						</mat-list>
					</div>

					@if (restaurant.specialDays?.length) {
						<!-- Besondere Tage Anzeige -->
						<div class="special-days-section">
							<h3>Besondere Tage / Zeiträume</h3>
							<mat-list>
								@for (day of restaurant.specialDays; track day.from) {
									<mat-list-item>
										<strong>
											{{ day.from | date: "dd.MM.yyyy" }}
											@if (day.to && day.to !== day.from) {
												<span
													>–{{ day.to | date: "dd.MM.yyyy" }}</span
												>
											}
										</strong>
										@if (day.reason) {
											<span>({{ day.reason }})</span>:
										}
										@if (day.openType === "geschlossen") {
											<span>geschlossen</span>
										}
										@if (
											day.openType !== "geschlossen" &&
											day.periods &&
											day.periods.length
										) {
											<span>
												@for (
													period of day.periods;
													let i = $index;
													track period.from
												) {
													<span>
														{{ i !== 0 ? ", " : "" }}
														{{ period.from }} –
														{{ period.to }}
													</span>
												}
											</span>
										}
									</mat-list-item>
								}
							</mat-list>
						</div>
					}

					<div class="edit-btn-row">
						<button
							mat-raised-button
							color="primary"
							(click)="startEdit()"
						>
							<mat-icon>edit</mat-icon> Bearbeiten
						</button>
					</div>
				</div>
			} @else {
				<!-- Bearbeiten-Modus -->
				<form autocomplete="off" class="edit-section">
					<div class="form-grid">
						<mat-form-field appearance="outline" class="full-width">
							<mat-label>Restaurant-Name</mat-label>
							<input
								matInput
								[(ngModel)]="restaurant.name"
								name="restaurantName"
								required
							/>
						</mat-form-field>
						<mat-form-field appearance="outline">
							<mat-label>Straße</mat-label>
							<input
								matInput
								[(ngModel)]="restaurant.adresse.strasse"
								name="strasse"
							/>
						</mat-form-field>
						<mat-form-field appearance="outline">
							<mat-label>PLZ</mat-label>
							<input
								matInput
								[(ngModel)]="restaurant.adresse.plz"
								name="plz"
							/>
						</mat-form-field>
						<mat-form-field appearance="outline">
							<mat-label>Ort</mat-label>
							<input
								matInput
								[(ngModel)]="restaurant.adresse.ort"
								name="ort"
							/>
						</mat-form-field>
						<mat-form-field appearance="outline">
							<mat-label>Land</mat-label>
							<input
								matInput
								[(ngModel)]="restaurant.adresse.land"
								name="land"
							/>
						</mat-form-field>
						<mat-form-field appearance="outline">
							<mat-label>Telefonnummer</mat-label>
							<input
								matInput
								[(ngModel)]="restaurant.telefonnummer"
								name="telefonnummer"
							/>
						</mat-form-field>
						<mat-form-field appearance="outline">
							<mat-label>E-Mail</mat-label>
							<input
								matInput
								[(ngModel)]="restaurant.email"
								name="email"
							/>
						</mat-form-field>
						<mat-form-field appearance="outline">
							<mat-label>Steuer-ID</mat-label>
							<input
								matInput
								[(ngModel)]="restaurant.steuerId"
								name="steuerId"
							/>
						</mat-form-field>
						<mat-form-field appearance="outline">
							<mat-label>Inhaber</mat-label>
							<input
								matInput
								[(ngModel)]="restaurant.inhaber"
								name="inhaber"
							/>
						</mat-form-field>
					</div>

					<!-- Öffnungszeiten Bearbeiten -->
					<div class="opening-section">
						<h3>Öffnungszeiten</h3>
						@for (
							group of restaurant.openingDaysGroups;
							let i = $index;
							track i
						) {
							<div class="group-block">
								<mat-card>
									<div class="group-header">
										<mat-form-field appearance="fill">
											<mat-label>Tage</mat-label>
											<mat-select
												[(ngModel)]="group.days"
												[name]="'days' + i"
												multiple
											>
												@for (
													day of getAvailableDays(group);
													track day
												) {
													<mat-option [value]="day">{{
														day
													}}</mat-option>
												}
											</mat-select>
										</mat-form-field>
										<button
											mat-icon-button
											color="warn"
											(click)="removeGroup(i)"
										>
											<mat-icon>delete</mat-icon>
										</button>
									</div>
									<mat-radio-group
										[value]="
											isDurchgehend(group) ? 'durchgehend' : 'pause'
										"
										(change)="setPeriodsType(group, $event.value)"
									>
										<mat-radio-button value="durchgehend"
											>Durchgehend geöffnet</mat-radio-button
										>
										<mat-radio-button value="pause"
											>Mit Pause</mat-radio-button
										>
									</mat-radio-group>
									@for (
										period of group.periods;
										let j = $index;
										track j
									) {
										<div class="period-row">
											<mat-form-field appearance="fill">
												<mat-label>Von</mat-label>
												<input
													matInput
													[(ngModel)]="period.from"
													[name]="'from' + i + j"
													type="time"
													step="60"
													required
												/>
											</mat-form-field>
											<mat-form-field appearance="fill">
												<mat-label>Bis</mat-label>
												<input
													matInput
													[(ngModel)]="period.to"
													[name]="'to' + i + j"
													type="time"
													step="60"
													required
												/>
											</mat-form-field>
										</div>
									}
								</mat-card>
							</div>
						}

						<button
							mat-stroked-button
							color="primary"
							type="button"
							(click)="addGroup()"
							[disabled]="getAvailableDays(null).length === 0"
						>
							<mat-icon>add</mat-icon> Weitere Tage hinzufügen
						</button>
					</div>

					<!-- Besondere Tage Bearbeiten -->
					<div class="special-days-section" style="margin-top: 2em">
						<h3>Besondere Tage / Zeiträume</h3>
						@for (
							day of restaurant.specialDays;
							let i = $index;
							track i
						) {
							<div
								class="special-day-row"
								style="
									display: flex;
									align-items: flex-start;
									gap: 1em;
									flex-wrap: wrap;
								"
							>
								<mat-form-field appearance="outline">
									<mat-label>Von</mat-label>
									<input
										matInput
										[(ngModel)]="day.from"
										[name]="'specialFrom' + i"
										type="date"
									/>
								</mat-form-field>
								<mat-form-field appearance="outline">
									<mat-label>Bis</mat-label>
									<input
										matInput
										[(ngModel)]="day.to"
										[name]="'specialTo' + i"
										type="date"
									/>
								</mat-form-field>
								<mat-form-field appearance="outline">
									<mat-label>Anlass / Grund</mat-label>
									<input
										matInput
										[(ngModel)]="day.reason"
										[name]="'specialReason' + i"
									/>
								</mat-form-field>
								<mat-radio-group
									[value]="day.openType"
									(change)="setSpecialDayType(day, $event.value)"
									[name]="'specialOpenType' + i"
									style="margin-top: 1.5em"
								>
									<mat-radio-button value="geschlossen"
										>geschlossen</mat-radio-button
									>
									<mat-radio-button value="durchgehend"
										>durchgehend geöffnet</mat-radio-button
									>
									<mat-radio-button value="pause"
										>mit Pause</mat-radio-button
									>
								</mat-radio-group>
								@if (day.openType === "durchgehend") {
									<ng-container>
										<div style="display: flex; gap: 0.5em">
											<mat-form-field
												appearance="outline"
												style="width: 100px"
											>
												<mat-label>Von</mat-label>
												<input
													matInput
													[(ngModel)]="day.periods[0].from"
													[name]="'specialPeriodFrom' + i + '0'"
													type="time"
												/>
											</mat-form-field>
											<mat-form-field
												appearance="outline"
												style="width: 100px"
											>
												<mat-label>Bis</mat-label>
												<input
													matInput
													[(ngModel)]="day.periods[0].to"
													[name]="'specialPeriodTo' + i + '0'"
													type="time"
												/>
											</mat-form-field>
										</div>
									</ng-container>
								}
								@if (day.openType === "pause") {
									<ng-container>
										<div
											style="
												display: flex;
												flex-direction: column;
												gap: 0.5em;
											"
										>
											<div style="display: flex; gap: 0.5em">
												<mat-form-field
													appearance="outline"
													style="width: 100px"
												>
													<mat-label>Von</mat-label>
													<input
														matInput
														[(ngModel)]="day.periods[0].from"
														[name]="'specialPeriodFrom' + i + '0'"
														type="time"
													/>
												</mat-form-field>
												<mat-form-field
													appearance="outline"
													style="width: 100px"
												>
													<mat-label>Bis</mat-label>
													<input
														matInput
														[(ngModel)]="day.periods[0].to"
														[name]="'specialPeriodTo' + i + '0'"
														type="time"
													/>
												</mat-form-field>
											</div>
											<div style="display: flex; gap: 0.5em">
												<mat-form-field
													appearance="outline"
													style="width: 100px"
												>
													<mat-label>Von</mat-label>
													<input
														matInput
														[(ngModel)]="day.periods[1].from"
														[name]="'specialPeriodFrom' + i + '1'"
														type="time"
													/>
												</mat-form-field>
												<mat-form-field
													appearance="outline"
													style="width: 100px"
												>
													<mat-label>Bis</mat-label>
													<input
														matInput
														[(ngModel)]="day.periods[1].to"
														[name]="'specialPeriodTo' + i + '1'"
														type="time"
													/>
												</mat-form-field>
											</div>
										</div>
									</ng-container>
								}

								<button
									mat-icon-button
									color="warn"
									(click)="restaurant.specialDays.splice(i, 1)"
									type="button"
									style="margin-top: 1.5em"
								>
									<mat-icon>delete</mat-icon>
								</button>
							</div>
						}

						<button
							mat-stroked-button
							color="primary"
							type="button"
							(click)="addSpecialDay()"
						>
							<mat-icon>add</mat-icon> Besonderen Zeitraum hinzufügen
						</button>
					</div>

					<div class="validation-errors">
						@for (err of validationErrors; track err) {
							<mat-error>{{ err }}</mat-error>
						}
					</div>
					<div class="form-actions">
						<button
							mat-raised-button
							color="primary"
							type="button"
							(click)="save()"
						>
							Speichern
						</button>
						<button mat-button type="button" (click)="editMode = false">
							Abbrechen
						</button>
					</div>
				</form>
			}
		</mat-card>

		<!-- TSE Verwaltung Card -->
		<mat-card class="main-card tse-card" style="margin-top: 2em">
			<mat-card-title>
				<mat-icon color="primary" style="margin-right: 8px">
					security
				</mat-icon>
				TSE Verwaltung
				<span style="flex: 1 1 auto"></span>
				@if (!tseEditMode) {
					<button
						mat-icon-button
						color="primary"
						(click)="tseEditMode = true"
					>
						<mat-icon>edit</mat-icon>
					</button>
				} @else {
					<button
						mat-icon-button
						color="primary"
						(click)="tseEditMode = false"
					>
						<mat-icon>close</mat-icon>
					</button>
				}
			</mat-card-title>
			<mat-divider></mat-divider>

			@if (!tseEditMode) {
				<div>
					@for (tse of tses; track tse.id) {
						<div class="tse-block">
							<div class="tse-header">
								<strong>{{ tse.name }}</strong>
								<span class="tse-status" [ngClass]="tse.status">{{
									tse.status
								}}</span>
							</div>
							<div class="tse-clients">
								@for (client of tse.clients; track client.id) {
									<div class="client-row">
										<mat-icon>devices</mat-icon>
										<span
											>{{ client.name }} ({{
												client.seriennummer
											}})</span
										>
									</div>
								}
								@if (!tse.clients.length) {
									<div class="client-row">
										<em>Keine Clients</em>
									</div>
								}
							</div>
						</div>
					}
				</div>
			}
			@if (tseEditMode) {
				<form autocomplete="off">
					@for (tse of tses; track tse.id) {
						<div class="tse-block-edit">
							<div class="tse-header-edit">
								<mat-form-field appearance="outline">
									<mat-label>TSE-Name</mat-label>
									<input
										matInput
										[(ngModel)]="tse.name"
										[name]="'tsename' + tse.id"
									/>
								</mat-form-field>
								<mat-form-field appearance="outline">
									<mat-label>Status</mat-label>
									<mat-select
										[(ngModel)]="tse.status"
										[name]="'tsestatus' + tse.id"
									>
										<mat-option value="aktiv">Aktiv</mat-option>
										<mat-option value="inaktiv">Inaktiv</mat-option>
										<mat-option value="wartung">Wartung</mat-option>
									</mat-select>
								</mat-form-field>
								<mat-form-field appearance="outline">
									<mat-label>PIN</mat-label>
									<input
										matInput
										[(ngModel)]="tse.pin"
										[name]="'tsepin' + tse.id"
										type="password"
									/>
								</mat-form-field>
								<button
									mat-icon-button
									color="warn"
									(click)="deleteTSE(tse)"
									type="button"
								>
									<mat-icon>delete</mat-icon>
								</button>
							</div>
							<div class="tse-clients-edit">
								@for (client of tse.clients; track client.id) {
									<div class="client-row-edit">
										<mat-form-field appearance="outline">
											<mat-label>Client-Name</mat-label>
											<input
												matInput
												[(ngModel)]="client.name"
												[name]="'clientname' + tse.id + client.id"
											/>
										</mat-form-field>
										<mat-form-field appearance="outline">
											<mat-label>Seriennummer</mat-label>
											<input
												matInput
												[(ngModel)]="client.seriennummer"
												[name]="
													'clientseriennummer' + tse.id + client.id
												"
											/>
										</mat-form-field>
										<button
											mat-icon-button
											color="warn"
											(click)="deleteClient(tse, client)"
											type="button"
										>
											<mat-icon>delete</mat-icon>
										</button>
									</div>
								}

								<button
									mat-stroked-button
									color="primary"
									type="button"
									(click)="addClient(tse)"
								>
									<mat-icon>add</mat-icon> Client hinzufügen
								</button>
							</div>
							<mat-divider style="margin: 1em 0"></mat-divider>
						</div>
					}

					<button
						mat-stroked-button
						color="primary"
						type="button"
						(click)="addTSE()"
					>
						<mat-icon>add</mat-icon> TSE hinzufügen
					</button>
				</form>
			}
		</mat-card>
	</div>
</app-settings-bar>
